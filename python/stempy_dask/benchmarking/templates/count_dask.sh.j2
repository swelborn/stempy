{% include "header.j2"  %}

# Much taken from https://gist.github.com/quasiben/5e5c6a394d1a5fab8fb1ee0cb338ed8c
set -xo pipefail
date
pwd

# load aliases like module (TODO: unsure if needed)
source /etc/profile

# Load Cuda Environment
module load cudatoolkit/11.7
module load PrgEnv-nvidia
module load Nsight-Systems
cd /source/stempy/python
export PYTHONPATH=$PYTHONPATH:$PWD

# Print python location
which python

# Prepare output directory
JOB_OUTPUT_DIR={{dask_settings.workdir}}
scheduler_file={{dask_settings.scheduler_file_path}}
rm -f $scheduler_file
cd /source/stempy/python
export PYTHONPATH=$PYTHONPATH:$PWD

# Setup image, preloads
preload_file=stempy_dask.preload_serializers
RMM_LOG_DIR="{{dask_settings.workdir}}/rmm-logs/"

echo "Using scheduler file in $image"
echo "Using preload file: $preload_file"
echo "Using RMM Log Directory: $RMM_LOG_DIR"

{% include "scheduler.sh.j2" %}

{% include "workers.sh.j2" %}